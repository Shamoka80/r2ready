
name: Security Audit

on:
  schedule:
    - cron: '0 2 * * 1' # Weekly on Monday at 2 AM
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

jobs:
  dependency-audit:
    runs-on: ubuntu-22.04
    name: Dependency Security Audit
    timeout-minutes: 15
    continue-on-error: true  # Don't block workflow on audit failures - report as warnings
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      continue-on-error: false

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies (root)
      continue-on-error: true
      run: npm ci || npm install || echo "âš ï¸  npm install failed in root"

    - name: Install dependencies (server)
      continue-on-error: true
      run: cd server && (npm ci || npm install || echo "âš ï¸  npm install failed in server")

    - name: Install dependencies (client)
      continue-on-error: true
      run: cd client && (npm ci || npm install || echo "âš ï¸  npm install failed in client")

    - name: Run npm audit (root)
      run: npm audit --audit-level=high
      continue-on-error: true
      id: audit-root

    - name: Run npm audit (server)
      run: cd server && npm audit --audit-level=high
      continue-on-error: true
      id: audit-server

    - name: Run npm audit (client)
      run: cd client && npm audit --audit-level=high
      continue-on-error: true
      id: audit-client

    - name: Install license checker
      run: npm install -g license-checker

    - name: Generate license report
      run: npx tsx scripts/generate-license-report.ts
      continue-on-error: true

    - name: Generate SBOM
      run: npx tsx scripts/generate-sbom.ts
      continue-on-error: true

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          reports/
          releases/sbom-latest.*
        retention-days: 30

    - name: Check for critical vulnerabilities
      continue-on-error: true
      run: |
        echo "ðŸ“Š Security Audit Summary:"
        echo "Root audit: ${{ steps.audit-root.outcome }}"
        echo "Server audit: ${{ steps.audit-server.outcome }}"
        echo "Client audit: ${{ steps.audit-client.outcome }}"
        
        if [ "${{ steps.audit-root.outcome }}" = "failure" ] || \
           [ "${{ steps.audit-server.outcome }}" = "failure" ] || \
           [ "${{ steps.audit-client.outcome }}" = "failure" ]; then
          echo "âš ï¸  High or critical vulnerabilities found in dependencies"
          echo "ðŸ’¡ Recommendation: Review and update vulnerable packages"
          echo "ðŸ’¡ Run 'npm audit fix' to attempt automatic fixes"
          echo "ðŸ’¡ For more details, check the audit output above"
          echo "â„¹ï¸  This is a warning - the workflow will continue"
          exit 0  # Explicitly exit with success code
        else
          echo "âœ… No high or critical vulnerabilities found"
          exit 0
        fi

  snyk-scan:
    runs-on: ubuntu-22.04
    name: Snyk Security Scan
    timeout-minutes: 15
    continue-on-error: true  # Don't block workflow if Snyk token is missing or scan fails
    # Run on all events (push, PR, schedule, manual)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      continue-on-error: false

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      continue-on-error: true
      run: npm ci || npm install || echo "âš ï¸  npm install failed"

    - name: Check Snyk token availability
      id: check-snyk-token
      run: |
        if [ -z "${{ secrets.SNYK_TOKEN }}" ] || [ "${{ secrets.SNYK_TOKEN }}" = "" ]; then
          echo "âš ï¸  SNYK_TOKEN secret is not configured"
          echo "ðŸ’¡ Snyk scan will be skipped. To enable Snyk scanning:"
          echo "   1. Get a Snyk API token from https://app.snyk.io/account"
          echo "   2. Add it as a repository secret named SNYK_TOKEN"
          echo "skip=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… SNYK_TOKEN is configured (will attempt scan)"
          echo "skip=false" >> $GITHUB_OUTPUT
        fi

    - name: Run Snyk to check for vulnerabilities
      if: steps.check-snyk-token.outputs.skip != 'true'
      uses: snyk/actions/node@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high --file=package.json

    - name: Run Snyk for server
      if: steps.check-snyk-token.outputs.skip != 'true'
      uses: snyk/actions/node@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high --file=server/package.json

    - name: Run Snyk for client
      if: steps.check-snyk-token.outputs.skip != 'true'
      uses: snyk/actions/node@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high --file=client/package.json

    - name: Snyk scan summary
      if: always()
      run: |
        if [ "${{ steps.check-snyk-token.outputs.skip }}" = "true" ]; then
          echo "âš ï¸  Snyk scan was skipped - SNYK_TOKEN not configured"
          echo "â„¹ï¸  This is not a failure - Snyk is optional"
        elif [ "${{ job.status }}" != "success" ]; then
          echo "âš ï¸  Snyk scan encountered issues (authentication or vulnerabilities)"
          echo "â„¹ï¸  Check the logs above for details"
          echo "â„¹ï¸  If authentication failed, verify SNYK_TOKEN is valid"
        else
          echo "âœ… Snyk scan completed successfully"
        fi

  codeql-analysis:
    runs-on: ubuntu-22.04
    name: CodeQL Security Analysis
    timeout-minutes: 30
    continue-on-error: true  # Don't fail the workflow on CodeQL errors
    
    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      continue-on-error: false

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      continue-on-error: true
      run: |
        npm ci || npm install || echo "âš ï¸  npm install failed in root"
        cd server && (npm ci || npm install || echo "âš ï¸  npm install failed in server")
        cd ../client && (npm ci || npm install || echo "âš ï¸  npm install failed in client")

    - name: Clean build artifacts
      run: |
        echo "ðŸ§¹ Cleaning build artifacts that may cause CodeQL syntax errors..."
        # Remove build output directories that may contain generated files with syntax issues
        rm -rf server/dist client/dist .next build coverage
        echo "âœ… Build artifacts cleaned"

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      continue-on-error: true
      with:
        languages: javascript
        config-file: .github/codeql/codeql-config.yml

    - name: Autobuild
      uses: github/codeql-action/autobuild@v4
      continue-on-error: true
      # CodeQL will analyze what it can even if some files have syntax errors

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      continue-on-error: true
      # Upload results even if there are warnings/errors - don't block the workflow

  security-scorecard:
    runs-on: ubuntu-22.04
    name: OSSF Security Scorecard
    timeout-minutes: 10
    continue-on-error: true  # Don't block workflow on scorecard issues
    # Run on all events (push, PR, schedule, manual)
    
    permissions:
      security-events: write
      id-token: write
      contents: read
      actions: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      continue-on-error: false
      with:
        persist-credentials: false

    - name: Run analysis
      uses: ossf/scorecard-action@v2.3.1
      with:
        results_file: results.sarif
        results_format: sarif
        publish_results: true

    - name: Upload SARIF results
      uses: github/codeql-action/upload-sarif@v4
      continue-on-error: true
      with:
        sarif_file: results.sarif
      # Note: Code scanning must be enabled in repository settings for upload to work
      # If not enabled, this step will fail but won't block the workflow

  notify-security-team:
    runs-on: ubuntu-22.04
    name: Notify Security Team
    timeout-minutes: 5
    needs: [dependency-audit, snyk-scan, codeql-analysis]
    # Always run (never skip) so it can be used as a required status check
    # Check internally if any jobs failed and only notify on failures
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      continue-on-error: false
      
    - name: Check for security job failures
      id: check-failures
      run: |
        if [ "${{ needs.dependency-audit.result }}" = "failure" ] || \
           [ "${{ needs.snyk-scan.result }}" = "failure" ] || \
           [ "${{ needs.codeql-analysis.result }}" = "failure" ]; then
          echo "has_failures=true" >> $GITHUB_OUTPUT
          echo "âš ï¸  Security audit failures detected"
        else
          echo "has_failures=false" >> $GITHUB_OUTPUT
          echo "âœ… All security audits passed - no notification needed"
        fi
      
    - name: Send notification
      if: steps.check-failures.outputs.has_failures == 'true'
      run: |
        echo "ðŸš¨ Security audit failed - notifying security team"
        echo "Failed jobs:"
        [ "${{ needs.dependency-audit.result }}" = "failure" ] && echo "  - Dependency Security Audit"
        [ "${{ needs.snyk-scan.result }}" = "failure" ] && echo "  - Snyk Security Scan"
        [ "${{ needs.codeql-analysis.result }}" = "failure" ] && echo "  - CodeQL Security Analysis"
        # Add actual notification logic here (email, Slack, etc.)
        # Example: curl -X POST https://hooks.slack.com/... -d '{"text":"Security audit failed"}'
      
    - name: Job completed
      if: always()
      run: |
        echo "âœ… Notify Security Team job completed"
        echo "This job always runs to ensure it can be used as a required status check"
